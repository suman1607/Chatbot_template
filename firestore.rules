/**
 * @fileoverview Firestore Security Rules for the application.
 *
 * Core Philosophy:
 * This ruleset enforces a workspace-centric security model. Users can only access
 * data within a workspace if their `uid` matches the `workspaceId`. This ensures
 * data isolation between different workspaces.
 *
 * Data Structure:
 * - /workspaces/{workspaceId}: Stores workspace metadata, accessible only by the owner.
 * - /workspaces/{workspaceId}/aiConfig: Stores the AI configuration for a workspace, accessible only by workspace members.
 * - /workspaces/{workspaceId}/trainingRuns/{runId}: Stores training run logs, accessible only by workspace members.
 *
 * Key Security Decisions:
 * - Users can only access resources within a workspace if their `uid` matches the `workspaceId`.
 * - Data validation is relaxed to allow for rapid prototyping.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    match /workspaces/{workspaceId} {
      /**
       * @description Allows read and write access to a workspace only if the user's UID matches the workspace ID.
       * @path /workspaces/{workspaceId}
       * @allow (read, write): User with UID "jaCCwV3IglYArRJq2PnZFuMblEk2" accessing workspace "jaCCwV3IglYArRJq2PnZFuMblEk2".
       * @deny (read, write): User with UID "differentUID" accessing workspace "jaCCwV3IglYArRJq2PnZFuMblEk2".
       * @principle Enforces workspace ownership.
       */
      allow read, write: if isOwner(workspaceId);

      match /aiConfig/{configId} {
        /**
         * @description Allows read and write access to an AI configuration only if the user's UID matches the workspace ID.
         * @path /workspaces/{workspaceId}/aiConfig/{configId}
         * @allow (read, write): User with UID "jaCCwV3IglYArRJq2PnZFuMblEk2" accessing aiConfig under workspace "jaCCwV3IglYArRJq2PnZFuMblEk2".
         * @deny (read, write): User with UID "differentUID" accessing aiConfig under workspace "jaCCwV3IglYArRJq2PnZFuMblEk2".
         * @principle Enforces workspace ownership for AI configurations.
         */
        allow read, write: if isOwner(workspaceId);
      }

      match /trainingRuns/{trainingRunId} {
        /**
         * @description Allows read and write access to a training run only if the user's UID matches the workspace ID.
         * @path /workspaces/{workspaceId}/trainingRuns/{trainingRunId}
         * @allow (read, write): User with UID "jaCCwV3IglYArRJq2PnZFuMblEk2" accessing trainingRuns under workspace "jaCCwV3IglYArRJq2PnZFuMblEk2".
         * @deny (read, write): User with UID "differentUID" accessing trainingRuns under workspace "jaCCwV3IglYArRJq2PnZFuMblEk2".
         * @principle Enforces workspace ownership for training runs.
         */
        allow read, write: if isOwner(workspaceId);
      }
    }
  }
}

function isOwner(workspaceId) {
  return request.auth.uid == workspaceId;
}